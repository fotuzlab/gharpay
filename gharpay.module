<?php

/**
 * @file
 * Gharpay module.
 */

// Set Gharapay API, password and Service url.
define('GP_API', variable_get('gharpay_api_key', ''));
define('GP_PASSWORD', variable_get('gharpay_password', ''));
define('GP_SERVICE_URL', variable_get('gharpay_service_url', ''));

// Check if library exists. Though already defined in hook_requirements()
// its a double check.
$gharpay_library = "./sites/all/libraries/gharpay/GharpayAPI.php";
if (file_exists($gharpay_library)) {
  require_once($gharpay_library);
  // Include dependent files.
  require_once("./" . drupal_get_path('module', 'gharpay') . "/gharpay.class.php");
}
else {
  drupal_set_message(t("Gharapay PHP library is either missing or named incorrectly. Check README.txt for details."), "error");
  return;
}

/**
 * Implements hook_permission().
 */
function gharpay_perm() {
  return array(
    'configure_gharpay',
    'access_gharpay',
  );
}

/**
 * Implements hook_menu().
 */
function gharpay_menu() {

  $items = array();

  $items['admin/config/services/gharpay'] = array(
    'title' => t('Configure Gharpay'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gharpay_credentials_form'),
    'access arguments' => array('configure_gharpay'),
    'file' => 'gharpay.credentials.inc',
    'description' => 'Configure credentials for Gharpay.',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/services/gharpay/configure'] = array(
    'title' => t('Configure Gharpay'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/services/gharpay/settings'] = array(
    'title' => t('Gharpay settings'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gharpay_config_form'),
    'access arguments' => array('configure_gharpay'),
    'file' => 'gharpay.admin.inc',
    'description' => 'Configure settings for Gharpay.',
    'type' => MENU_LOCAL_TASK,
  );
  $items['gharpay/services/cities'] = array(
    'title' => t('Available cities'),
    'page callback' => 'gharpay_available_cities',
    'access arguments' => array('access_gharpay'),
    'type' => MENU_CALLBACK,
  );
  $items['gharpay/push'] = array(
    'title' => t('Gharpay push service'),
    'page callback' => 'gharpay_push_service',
    'access arguments' => array('access_gharpay'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Get list of available cities with pincodes
 * where Gharpay provides its services.
 */
function gharpay_available_cities() {
  $gharpay = new GpGharpayAPI();
  $cities = $gharpay->getCityList();
  $form = array();
  foreach ($cities as $key => $city) {
    $form[$city] = array(
        '#type' => 'fieldset',
        '#title' => t('@city', array('@city' => $city)),
        '#collapsible' => TRUE,
        '#collapsed' => TRUE,
      );
    $form[$city][] = array(
        '#type' => 'select',
        '#title' => t('Available pincodes'),
        '#options' => $gharpay->getPincodesInCity($city),
      );
  }
  return drupal_render($form);
}

/**
 * Create an array of client details to pass to
 * createOrder() function provided by Gharpay API
 * @param
 *   an object of user submitted form. Check API documentation for mandatory fields.
 * @return
 *   an array to pass to createOrder() function.
 */
function gharpay_create_order_client_details($order) {

  $array = array();

  // Mandatory fields.
  // Should have already passed validation.
  $array = array(
      'firstName' => $order->billing_first_name,
      'contactNo' => $order->billing_phone,
      'address' => str_replace("<BR />", ",", uc_order_address($order, 'billing')),
    );
  // These are optional fields.
  // They did not go under validation earlier.
  if (!empty($order->primary_email)) {
    $array['email'] = $order->primary_email;
  }
  if (!empty($order->billing_last_name)) {
    $array['lastName'] = $order->billing_last_name;
  }
  if (!empty($order->prefix)) {
    $array['prefix'] = $order->prefix;
  }

  return $array;
}

/**
 * Create an array of order details to pass to
 * createOrder() function provided by Gharpay API
 * @param
 *   an object of user submitted form. Check API documentation for mandatory fields.
 * @return
 *   an array to pass to createOrder() function.
 */
function gharpay_create_order_order_details($order) {

  $array = array();
  // Mandatory fields.
  $array = array(
      // Should have already passed validation.
      'pincode' => $order->billing_postal_code,
      // Ubercart validation assumed.
      'orderAmount' => $order->order_total,
      // Ubercart validation assumed.
      'clientOrderID' => $order->order_id,
      // Append the date of order.
      'deliveryDate' => date("d-m-Y"),
    );

  // These are optional fields.
  // They did not go under validation earlier.
  if (!empty($order->template_id)) {
    $array['template_id'] = $order->template_id;
  }
  if (!empty($order->payment_mode)) {
    $array['payment_mode'] = $order->payment_mode;
  }

  // @TODO
  // Leaving Additional information intentionally.
  // This would be added via a hook later.

  return $array;
}

/**
 * Create an array of product details to pass to
 * createOrder() function provided by Gharpay API
 * @param
 *   an object of user submitted form. Check API documentation for mandatory fields.
 * @return
 *   an array to pass to createOrder() function if products are available
 *   FALSE otherwise.
 */
function gharpay_create_order_product_details($order) {
  $array = array();
  // Check if products exist.
  if ($order->products) {
    foreach ($order->products as $op_id => $product) {
      $product_description = gharpay_get_order_description($product->nid);
      $array[$op_id] = array(
          'orderId' => $product->order_id,
          'productID' => $product->order_product_id,
          'productQuantity' => $product->qty,
          'unitCost' => $product->price,
          // Need to pass default value for product description
          // else GharpayAPI would throw an exception.
          'productDescription' => $product_description ? $product->title . ": " . $product_description : $product->title,
        );
    }
    return $array;
  }
  else {
    return FALSE;
  }
}

/**
 * Ubercart does not provide product description in $order variable
 * though node id is available.
 * This function would extract node body field of the product node.
 * @param
 *   Node id of product.
 * @return
 *   Body field value of node.
 */
function gharpay_get_order_description($nid) {
  return db_result(db_query("SELECT body FROM {node_revisions} WHERE nid = %d", $nid));
}

/**
 * Format the surcharge display text.
 */
function gharpay_display_surcharge() {
  $surcharge = variable_get('gharpay_surcharge', '');
  if (empty($surcharge)) {
    return '';
  }
  // Trim all the white spaces.
  $surcharge = preg_replace('/\s+/', '', $surcharge);

  // Check if the amount is in percent or units.
  $s_unit = substr($surcharge, -1);
  if ($s_unit != '%') {
    return t("Surcharge of Rs. @s is applicable.", array("@s" => $surcharge));
  }
  else {
    return t("Surcharge of @s is applicable.", array("@s" => $surcharge));
  }
}
<<<<<<< HEAD

/**
 * This function is called to invoke Gharpay's push service.
 * It would update the orders' statuses.
 */
function gharpay_push_service() {
  $params = $_GET;
  // Check if order_id and client_order_id are present.
  if ($_GET['order_id'] || $_GET['client_order_id']) {
    print "Either Order ID or Client Order ID is missing.";
    exit;
  }
  try {
    $gharpay = new GpGharpayAPI();
    $push = $gharpay->viewOrderStatus($_GET['order_id']);
    $client_order_id = $_GET['client_order_id'];
    $status = strtolower(trim($push['status']));

    // Map Gharpay keys with Ubercart.
    switch ($status) {
      case 'On-The-Way':
        $status = 'processing';
        break;
      case 'Delivered':
        $status = 'completed';
        break;
      case 'Failed':
        $status = 'gharpay_failed';
        break;
      case 'Cancelled by Client':
        $status = 'gharpay_cancelled_by_client';
        break;
      case 'Cancelled by Customer':
        $status = 'gharpay_cancelled_by_customer';
        break;
      case 'Deferred by Customer':
        $status = 'gharpay_deferred_by_client';
        break;
      case 'Invalid':
        $status = 'gharpay_invalid';
        break;
    }

    if (function_exists('uc_order_update_status')) {
      // Update status.
      $update = uc_order_update_status($client_order_id, $status);
    }
    else {
      print 'ERROR: Function not found: uc_order_update_status';
    }
  }
  catch(Exception $e) {
    print_r($e);
  }
}
=======
>>>>>>> 58643c1af66693c4fcfa19f7f426a3c2318e1e59
